name: tests

on: [ push, pull_request ]

jobs:
  lint:
    name: Source code linting
    runs-on: ubuntu-latest
    steps:
      -
        uses: actions/checkout@v4

      -
        name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.4
          extensions: intl, mbstring, pdo_sqlite
          ini-file: development

      -
        name: Validate composer.json
        run: composer validate

      - name: Get composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      -
        name: Cache composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: composer-

      -
        name: Install composer dependencies
        run: composer install --prefer-dist --no-progress

      -
        name: PHP Linting
        run: composer lint:php

      -
        name: Editorconfig Linting
        run: composer lint:editorconfig

      -
        name: Phpstan Linting
        run: composer lint:phpstan


  test:
    name: Testing (PHP ${{ matrix.php-version }}, TYPO3 ${{ matrix.typo3-version }})
    needs: lint

    strategy:
      fail-fast: false
      matrix:
        php-version: [8.5, 8.4, 8.3, 8.2]
        typo3-version: ['^14', '^13', '^12']
        exclude:
          - php-version: 8.5
            typo3-version: '^12'

    uses: ./.github/workflows/_test.yaml
    with:
      php-version: ${{ matrix.php-version }}
      typo3-version: ${{ matrix.typo3-version }}
      composer-remove: saschaegerer/phpstan-typo3
      unit-coverage-name: coverage-unit-${{ matrix.php-version }}-${{ matrix.typo3-version }}
      functional-coverage-name: coverage-functional-${{ matrix.php-version }}-${{ matrix.typo3-version }}

  test-doc:
    name: Test documentation rendering
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test if the documentation will render without warnings
        run: |
          mkdir -p Documentation-GENERATED-temp \
          && docker run --rm --pull always -v $(pwd):/project \
             ghcr.io/typo3-documentation/render-guides:latest --config=Documentation --no-progress --fail-on-log
